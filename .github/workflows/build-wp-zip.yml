name: Build spectre-icons.zip (commit to repo)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: spectre-icons
      MAIN_FILE: spectre-icons.php
      ZIP_PATH: dist/spectre-icons.zip
      WP_ORG_README: .wordpress-org/README.md

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build clean WP.org ZIP
        run: |
          set -euo pipefail

          ROOT="$GITHUB_WORKSPACE"
          OUT="$ROOT/dist/wp"
          DEST="$OUT/${PLUGIN_SLUG}"
          TMP_README="$(mktemp)"

          rm -rf "$OUT"
          mkdir -p "$DEST"
          mkdir -p "$ROOT/dist"

          if [ ! -f "$ROOT/${MAIN_FILE}" ]; then
            echo "ERROR: Missing main plugin file: $ROOT/${MAIN_FILE}"
            exit 1
          fi

          if [ -f "$ROOT/readme.txt" ]; then
            cp "$ROOT/readme.txt" "$TMP_README"
          elif [ -f "$ROOT/${WP_ORG_README}" ]; then
            cp "$ROOT/${WP_ORG_README}" "$TMP_README"
          else
            echo "ERROR: Missing readme.txt or .wordpress-org/README.md"
            exit 1
          fi

          # Copy only WordPress.org plugin runtime files
          cp "$ROOT/${MAIN_FILE}" "$DEST/"
          cp "$TMP_README" "$DEST/readme.txt"

          for d in includes assets build languages vendor; do
            if [ -d "$ROOT/$d" ]; then
              cp -R "$ROOT/$d" "$DEST/"
            fi
          done

          for f in LICENSE license.txt LICENSE.md; do
            if [ -f "$ROOT/$f" ]; then
              cp "$ROOT/$f" "$DEST/"
            fi
          done

          # Remove any dev-only leftovers that slipped in
          rm -rf "$DEST/.git" "$DEST/.github" "$DEST/.vscode" "$DEST/node_modules" \
                 "$DEST/src" "$DEST/tests" "$DEST/test" "$DEST/__tests__" \
                 "$DEST/.turbo" "$DEST/.cache" || true

          find "$DEST" -maxdepth 2 -type f \( \
            -name "package.json" -o -name "package-lock.json" -o -name "pnpm-lock.yaml" -o -name "yarn.lock" -o \
            -name "tsconfig.json" -o -name "tsup.config.*" -o -name "vite.config.*" -o -name "webpack.config.*" -o \
            -name ".eslintrc*" -o -name ".prettierrc*" -o -name "eslint.config.*" -o -name "prettier.config.*" \
          \) -print -delete || true

          test -f "$DEST/${MAIN_FILE}"
          test -f "$DEST/readme.txt"

          rm -f "$ROOT/${ZIP_PATH}"
          ( cd "$OUT" && zip -r "$ROOT/${ZIP_PATH}" "${PLUGIN_SLUG}" -x "*.DS_Store" )

          echo "Built $ROOT/${ZIP_PATH}"
          unzip -l "$ROOT/${ZIP_PATH}" | sed -n '1,40p'

      - name: Commit ZIP back to repo (overwrite)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${ZIP_PATH}"

          if git diff --cached --quiet; then
            echo "No changes to ${ZIP_PATH}; nothing to commit."
            exit 0
          fi

          git commit -m "chore: update dist/spectre-icons.zip"
          git push
