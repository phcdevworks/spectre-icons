name: Build spectre-icons.zip (commit to repo)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: spectre-icons
      MAIN_FILE: spectre-icons.php
      ZIP_PATH: dist/spectre-icons.zip
      WP_ORG_README: .wordpress-org/README.md

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build clean WP.org ZIP
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$GITHUB_WORKSPACE"
          OUT="$ROOT/dist/wp"
          DEST="$OUT/${PLUGIN_SLUG}"

          rm -rf "$OUT"
          mkdir -p "$DEST"
          mkdir -p "$ROOT/dist"

          # --- Required files ---
          if [ ! -f "$ROOT/${MAIN_FILE}" ]; then
            echo "ERROR: Missing main plugin file: $ROOT/${MAIN_FILE}"
            exit 1
          fi

          if [ ! -f "$ROOT/${WP_ORG_README}" ]; then
            echo "ERROR: Missing ${WP_ORG_README}"
            exit 1
          fi

          # --- Copy runtime plugin files using rsync ---
          rsync -a --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '.vscode/' \
            --exclude 'node_modules/' \
            --exclude 'src/' \
            --exclude 'tests/' \
            --exclude 'test/' \
            --exclude '__tests__/' \
            --exclude '.turbo/' \
            --exclude '.cache/' \
            --exclude '.env*' \
            --exclude '*.map' \
            --exclude '*.log' \
            --exclude 'coverage/' \
            --exclude 'tmp/' \
            --exclude '.DS_Store' \
            "$ROOT/" "$DEST/"

          # Remove dev-only configs if they slipped in
          find "$DEST" -maxdepth 2 -type f \( \
            -name "package.json" -o -name "package-lock.json" -o -name "pnpm-lock.yaml" -o -name "yarn.lock" -o \
            -name "tsconfig.json" -o -name "tsup.config.*" -o -name "vite.config.*" -o -name "webpack.config.*" -o \
            -name ".eslintrc*" -o -name ".prettierrc*" -o -name "eslint.config.*" -o -name "prettier.config.*" \
          \) -print -delete || true

          # Place README.md at plugin root (as-is)
          cp "$ROOT/${WP_ORG_README}" "$DEST/README.md"

          # Sanity checks
          test -f "$DEST/${MAIN_FILE}"
          test -f "$DEST/README.md"

          # Build zip (must contain plugin folder)
          rm -f "$ROOT/${ZIP_PATH}"
          ( cd "$OUT" && zip -r "$ROOT/${ZIP_PATH}" "${PLUGIN_SLUG}" -x "*.DS_Store" )

          echo "Built $ROOT/${ZIP_PATH}"
          unzip -l "$ROOT/${ZIP_PATH}" | sed -n '1,80p'

      - name: Commit ZIP back to repo (overwrite)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${ZIP_PATH}"

          if git diff --cached --quiet; then
            echo "No changes to ${ZIP_PATH}; nothing to commit."
            exit 0
          fi

          git commit -m "chore: update dist/spectre-icons.zip"
          git push
