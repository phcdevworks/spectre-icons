name: Build spectre-icons.zip

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: spectre-icons
      MAIN_FILE: spectre-icons.php
      ZIP_PATH: dist/spectre-icons.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build clean WP.org ZIP
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$GITHUB_WORKSPACE"
          OUT="$ROOT/dist/wp"
          DEST="$OUT/${PLUGIN_SLUG}"

          rm -rf "$OUT"
          mkdir -p "$DEST"
          mkdir -p "$ROOT/dist"

          # --- Required files ---
          if [ ! -f "$ROOT/${MAIN_FILE}" ]; then
            echo "ERROR: Missing main plugin file: $ROOT/${MAIN_FILE}"
            exit 1
          fi

          if [ ! -f "$ROOT/readme.txt" ]; then
            echo "ERROR: Missing readme.txt"
            exit 1
          fi

          # --- Copy only runtime plugin files ---
          cp "$ROOT/${MAIN_FILE}" "$DEST/"
          cp "$ROOT/readme.txt" "$DEST/"

          for d in includes assets build languages vendor; do
            if [ -d "$ROOT/$d" ]; then
              cp -R "$ROOT/$d" "$DEST/"
            fi
          done

          # Keep iconpacks in the ZIP for distribution

          for f in LICENSE license.txt LICENSE.md; do
            if [ -f "$ROOT/$f" ]; then
              cp "$ROOT/$f" "$DEST/"
            fi
          done

          # Sanity checks
          test -f "$DEST/${MAIN_FILE}"
          test -f "$DEST/readme.txt"

          # Build zip with top-level plugin folder "spectre-icons/"
          rm -f "$ROOT/${ZIP_PATH}"
          ( cd "$OUT" && zip -r "$ROOT/${ZIP_PATH}" "${PLUGIN_SLUG}" -x "*.DS_Store" )

          echo "Built $ROOT/${ZIP_PATH}"
          unzip -l "$ROOT/${ZIP_PATH}" | sed -n '1,40p'

      - name: Commit ZIP back to repo (overwrite)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${ZIP_PATH}"

          if git diff --cached --quiet; then
            echo "No changes to ${ZIP_PATH}; nothing to commit."
            exit 0
          fi

          git commit -m "chore: update dist/spectre-icons.zip"
          git push
