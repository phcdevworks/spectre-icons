name: Deploy to WordPress.org

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.1.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: spectre-icons
      MAIN_FILE: spectre-icons.php
      SVN_URL: https://plugins.svn.wordpress.org/spectre-icons

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SVN
        run: sudo apt-get update && sudo apt-get install -y subversion rsync

      - name: Get version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.version }}"
          # Basic sanity: allow digits + dots only (prevents "main", "foo", etc.)
          if ! echo "$VERSION" | grep -Eq '^[0-9]+(\.[0-9]+)*$'; then
            echo "ERROR: Invalid version '$VERSION'. Use numeric versions like 1.2.3"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Deploying version: $VERSION"

      - name: Build clean distribution
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$GITHUB_WORKSPACE"
          DIST="$ROOT/dist"

          rm -rf "$DIST"
          mkdir -p "$DIST"

          # --- Required files validation ---
          if [ ! -f "$ROOT/${MAIN_FILE}" ]; then
            echo "ERROR: Missing main plugin file: $ROOT/${MAIN_FILE}"
            exit 1
          fi

          if [ ! -f "$ROOT/readme.txt" ]; then
            echo "ERROR: Missing readme.txt"
            exit 1
          fi

          # --- Copy only runtime plugin files ---
          cp "$ROOT/${MAIN_FILE}" "$DIST/"
          cp "$ROOT/readme.txt" "$DIST/"

          for d in includes assets build languages vendor; do
            if [ -d "$ROOT/$d" ]; then
              cp -R "$ROOT/$d" "$DIST/"
            fi
          done

          # Include license file
          if [ -f "$ROOT/license.txt" ]; then
            cp "$ROOT/license.txt" "$DIST/license.txt"
          elif [ -f "$ROOT/LICENSE" ]; then
            cp "$ROOT/LICENSE" "$DIST/license.txt"
          fi

          # Sanity checks
          test -f "$DIST/${MAIN_FILE}"
          test -f "$DIST/readme.txt"

          echo "Distribution files prepared successfully"
          find "$DIST" -maxdepth 2 -type f | sed 's|^| - |'

      - name: Deploy to WordPress.org SVN
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.version.outputs.version }}"
          ROOT="$GITHUB_WORKSPACE"
          DIST="$ROOT/dist"
          SVN_DIR="$ROOT/svn"
          SVN_USERNAME="${{ secrets.SVN_USERNAME }}"
          SVN_PASSWORD="${{ secrets.SVN_PASSWORD }}"

          # Test credentials early - fail fast if auth fails
          echo "Testing SVN credentials..."
          if ! svn info "$SVN_URL" \
            --username "$SVN_USERNAME" \
            --password "$SVN_PASSWORD" \
            --non-interactive \
            --no-auth-cache >/dev/null 2>&1; then
            echo "ERROR: SVN authentication failed. Check SVN_USERNAME and SVN_PASSWORD secrets."
            exit 1
          fi

          echo "Checking out SVN..."
          svn checkout "$SVN_URL" "$SVN_DIR" --depth immediates --non-interactive --no-auth-cache \
            --username "$SVN_USERNAME" --password "$SVN_PASSWORD"
          svn update "$SVN_DIR/trunk" --set-depth infinity --non-interactive --no-auth-cache \
            --username "$SVN_USERNAME" --password "$SVN_PASSWORD"
          svn update "$SVN_DIR/assets" --set-depth infinity --non-interactive --no-auth-cache \
            --username "$SVN_USERNAME" --password "$SVN_PASSWORD" || true
          svn update "$SVN_DIR/tags" --set-depth immediates --non-interactive --no-auth-cache \
            --username "$SVN_USERNAME" --password "$SVN_PASSWORD"

          echo "Sync dist -> trunk (clean deploy)..."
          rm -rf "$SVN_DIR/trunk"/*
          rsync -av --delete "$DIST/" "$SVN_DIR/trunk/"

          echo "SVN add/delete reconciliation..."
          cd "$SVN_DIR/trunk"
          svn status | awk '/^\?/ {print $2}' | xargs -r svn add
          svn status | awk '/^\!/ {print $2}' | xargs -r svn delete

          echo "Sync plugin directory assets -> SVN /assets (banners/icons/screenshots)..."
          WPORG_ASSETS_DIR="$ROOT/.wordpress-org"
          if [ -d "$WPORG_ASSETS_DIR" ]; then
            rsync -av --delete "$WPORG_ASSETS_DIR/" "$SVN_DIR/assets/"
            cd "$SVN_DIR/assets"
            svn status | awk '/^\?/ {print $2}' | xargs -r svn add
            svn status | awk '/^\!/ {print $2}' | xargs -r svn delete
          else
            echo "No $WPORG_ASSETS_DIR directory found; skipping wp.org assets sync."
          fi

          echo "Commit trunk/assets changes..."
          cd "$SVN_DIR"
          svn commit -m "Deploy version $VERSION" \
            --username "$SVN_USERNAME" \
            --password "$SVN_PASSWORD" \
            --non-interactive \
            --no-auth-cache

          echo "Create SVN tag $VERSION (URL-based copy)..."
          svn copy \
            "$SVN_URL/trunk" \
            "$SVN_URL/tags/$VERSION" \
            -m "Tagging version $VERSION" \
            --username "$SVN_USERNAME" \
            --password "$SVN_PASSWORD" \
            --non-interactive \
            --no-auth-cache \
            --non-interactive \
            --no-auth-cache

          echo "Successfully deployed version $VERSION to WordPress.org"
